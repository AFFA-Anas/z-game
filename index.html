<!DOCTYPE html>
<html>
<head>
  <title>Firebase Auth Game</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-functions-compat.js"></script>
</head>
<body>
  <h1 id="yourNumber">Your Number: -</h1>
  <h1 id="opponentNumber">Opponent's Number: -</h1>
  <button onclick="assignRandomNumber()">Generate Number</button>

  <script>
    // ðŸ§  Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDaHiA8qZIin9Vh3TDsmb4Qp9wW3oOEAQw",
      authDomain: "z-ggame.firebaseapp.com",
      databaseURL: "https://z-ggame-default-rtdb.firebaseio.com/",
      projectId: "z-ggame",
      storageBucket: "z-ggame.firebasestorage.app",
      messagingSenderId: "96114095227",
      appId: "1:96114095227:web:f90baf6aa3c86acdee9ede",
      measurementId: "G-0PM64J227W"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const functions = firebase.functions();

    let currentUid = null;
    const gameRef = db.ref("games/default");

    firebase.auth().signOut().then(() => {
      // Anonymous login
      firebase.auth().signInAnonymously().then(() => {
        currentUid = firebase.auth().currentUser.uid;
        console.log("Signed in anonymously as", currentUid);

        // Realtime listener
        gameRef.on("value", (snapshot) => {
          console.log("new data");
          const data = snapshot.val();
          console.log(data);
          if (!data) return;

          // Show your last number
          if (data[currentUid] && data[currentUid].numbers) {
          const myNumbersArray = Object.values(data[currentUid].numbers);
          const myLast = myNumbersArray.sort((a, b) => a.createdAt - b.createdAt).pop();
          document.getElementById("yourNumber").innerText = "Your Number: " + myLast.number;
          }

          // Show opponent's last number
          const opponentId = Object.keys(data).find(id => id !== currentUid);
          if (opponentId && data[opponentId] && data[opponentId].numbers) {
          const opponentNumbersArray = Object.values(data[opponentId].numbers);
          const oppLast = opponentNumbersArray.sort((a, b) => a.createdAt - b.createdAt).pop();
          document.getElementById("opponentNumber").innerText = "Opponent's Number: " + oppLast.number;
          }
        });
      }).catch(console.error);
    });
    // Send number via Cloud Function
    async function assignRandomNumber() {
      const user = firebase.auth().currentUser;
      if (!user) {
        console.error("User not signed in");
        return;
      }

      const idToken = await user.getIdToken();

      const response = await fetch("https://us-central1-z-ggame.cloudfunctions.net/assignRandomNumber", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + idToken
        }
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Failed:", errorText);
        return;
      }

      const data = await response.json();
      console.log("Server response:", data);
    }

  </script>
</body>
</html>
